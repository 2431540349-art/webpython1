{% extends 'html/dashboard_base.html' %}
{% load static %}

{% block title %}L√†m ƒë·ªÅ - {{ exam.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'accounts/css/user_dashboard.css' %}">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
  .question { margin-bottom: 18px; }
  .choices label { display:block; margin-bottom:6px; }
  .btn { padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; }
  .btn:disabled { opacity: 0.6; cursor: not-allowed; }
  .btn-primary { background: #2563eb; color: white; border: none; }
  .btn-secondary { background: #e5e7eb; color: #374151; border: none; }
  .recorder { border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px; background: #fff; margin-top: 12px; }
  .rec-status { display: inline-block; padding: 4px 8px; border-radius: 4px; background: #f3f4f6; }
  .volume-meter {
    width: 300px;
    height: 20px;
    background: #1a1a1a;
    border-radius: 4px;
    overflow: hidden;
    margin: 8px 0;
    position: relative;
    border: 1px solid #333;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
  }
  .volume-meter .level {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, 
      #4ade80 0%, 
      #22c55e 40%, 
      #eab308 70%, 
      #ef4444 90%
    );
    transition: width 0.05s ease;
    opacity: 0;
    position: relative;
    box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
  }
  .volume-meter .level::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(180deg,
      rgba(255,255,255,0.2) 0%,
      rgba(255,255,255,0.1) 50%,
      rgba(0,0,0,0.1) 51%,
      rgba(0,0,0,0.2) 100%
    );
  }
  .volume-meter.active .level {
    opacity: 1;
  }
  .volume-meter .scale {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    justify-content: space-between;
    padding: 0 4px;
  }
  .volume-meter .scale::before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    background-image: repeating-linear-gradient(
      90deg,
      rgba(255,255,255,0.1) 0px,
      rgba(255,255,255,0.1) 1px,
      transparent 1px,
      transparent 30px
    );
  }
  /* Listening player styles */
  .listening-player { position: relative; background: linear-gradient(90deg, #0f1724, #1db954); border-radius: 12px; padding: 18px; color: #fff; display:flex; align-items:center; gap:12px }
  .listening-player .media { flex: 1; }
  .listening-player .play-overlay { width:56px; height:56px; border-radius:50%; background: rgba(255,255,255,0.12); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:20px }
  .listening-player .meta { font-weight:700 }
  .listening-player video, .listening-player audio { width:100%; height:48px; border-radius:8px; background:#000 }
</style>
{% endblock %}

{% block content %}
<section class="progress-page">
  <div class="progress-container">
    <div class="progress-header">
      <h1>{{ exam.title }} ‚Äî {{ exam.get_skill_display }}</h1>
      <p>{{ exam.description }}</p>
      <div style="margin-top:8px;font-size:0.9rem;color:#6b7280">Internal skill key: <strong>{{ exam.skill }}</strong></div>
    </div>

    <form method="post" action="{% url 'accounts:submit_mock_exam' exam.id %}">
      {% csrf_token %}
      {% for q in questions %}
      <div class="question">
        <div><strong>C√¢u {{ forloop.counter }}.</strong> {{ q.text }}</div>

        {# Listening: show media player if available and keep choices for comprehension #}
        {% if exam.skill == 'listening' and q.media_file %}
          <div class="listening-player" style="margin:8px 0">
            <div class="play-overlay" title="Play/Pause">‚ñ∂</div>
            <div class="media">
              <audio preload="none">
                <source src="{{ q.media_file.url }}" />
                Your browser does not support the audio element.
              </audio>
            </div>
            <div class="meta">Nghe v√† tr·∫£ l·ªùi</div>
          </div>
        {% endif %}

        {# Reading: if exam is reading and question has an image/media, show it as an image block #}
        {% if exam.skill == 'reading' and q.media_file %}
          <div class="reading-media" style="margin:8px 0">
            <img src="{{ q.media_file.url }}" alt="H√¨nh ·∫£nh cho c√¢u h·ªèi {{ forloop.counter }}" style="max-width:100%; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.08)">
          </div>
        {% endif %}

  {# Choices (if any) - useful for listening/reading comprehension #}
  {% if q.choices.count %}
        <div class="choices">
          {% for c in q.choices.all %}
            <label><input type="radio" name="question_{{ q.id }}" value="{{ c.id }}"> {{ c.text }}</label>
          {% endfor %}
        </div>
        {% endif %}

        {# Speaking: Web Speech API recorder + sample answer comparison #}
        {% if exam.skill == 'speaking' %}
          <div class="recorder" data-qid="{{ q.id }}" data-auto-weight="{{ exam.auto_weight|default:0.7 }}" data-lang="{{ exam.speech_language|default:'en-US' }}" {% if q.sample_answer %}data-sample="{{ q.sample_answer|escapejs }}"{% endif %}>
            <div class="sample-answer" style="margin:8px 0; padding:12px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0">
              <div style="font-weight:600; margin-bottom:4px">C√¢u m·∫´u:</div>
              <div style="color:#475569">{{ q.sample_answer }}</div>
            </div>
            <div class="controls" style="margin:12px 0; display:flex; gap:8px; align-items:center">
              <button type="button" class="btn btn-primary start-rec">
                <span class="icon">üé§</span> B·∫Øt ƒë·∫ßu ƒë·ªçc
              </button>
              <button type="button" class="btn btn-secondary stop-rec" disabled>D·ª´ng</button>
              <button type="button" class="btn btn-primary grade-speech" style="display:none">Ch·∫•m ƒëi·ªÉm</button>
              <div class="status-box" style="margin-left:12px; padding:6px 12px; border-radius:6px; font-size:14px">
                <span class="rec-status">Ch∆∞a thu √¢m</span>
                <div class="volume-meter">
                  <div class="level"></div>
                  <div class="scale"></div>
                </div>
                <div class="accuracy" style="margin-top:4px"></div>
              </div>
            </div>
            <input type="hidden" name="speaking_q_{{ q.id }}" class="speaking-input">
            <input type="hidden" name="speaking_score_{{ q.id }}" class="speaking-score-input">
            <div class="transcript" style="margin-top:8px; color:#64748b"></div>
          </div>
        {% endif %}

        {# Writing: textarea for written answer. Show ONLY when exam skill is 'writing' #}
        {% if exam.skill == 'writing' %}
          <div class="writing-block" style="margin-top:8px">
            <label for="writing_q_{{ q.id }}" style="font-weight:700; display:block; margin-bottom:6px">Vi·∫øt c√¢u tr·∫£ l·ªùi</label>
            <textarea id="writing_q_{{ q.id }}" name="writing_q_{{ q.id }}" rows="8" class="writing-input" style="width:100%; padding:12px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px;" placeholder="Vi·∫øt c√¢u tr·∫£ l·ªùi t·∫°i ƒë√¢y..."></textarea>
          </div>
        {% endif %}

      </div>
      {% endfor %}

      <div>
        <button type="submit" class="btn btn-primary">N·ªôp b√†i</button>
        <a href="{% url 'accounts:mock_exams_list' %}" class="btn btn-secondary">H·ªßy</a>
      </div>
    </form>
  </div>
</section>
{% if exam.skill == 'speaking' %}
  <script src="{% static 'accounts/js/recognizer.js' %}" defer></script>
{% endif %}
{% if exam.skill == 'listening' %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.listening-player').forEach(player => {
    const overlay = player.querySelector('.play-overlay');
    const audio = player.querySelector('audio');
    if (!audio || !overlay) return;
    overlay.addEventListener('click', function () {
      if (audio.paused) {
        audio.play();
        overlay.textContent = '‚ùö‚ùö';
      } else {
        audio.pause();
        overlay.textContent = '‚ñ∂';
      }
    });
    audio.addEventListener('ended', function () { overlay.textContent = '‚ñ∂'; });
  });
});
</script>
{% endif %}
{% endblock %}
