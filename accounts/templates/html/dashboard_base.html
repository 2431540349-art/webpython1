{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Learning Platform{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'accounts/css/user_dashboard.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{% static 'accounts/js/navigation.js' %}" defer></script>
    {% if user.is_authenticated %}
    <link rel="stylesheet" href="{% static 'accounts/css/ai_chat.css' %}">
    {% endif %}
    {% block extra_css %}{% endblock %}
</head>
<body>

<header class="top-nav">
    <button class="menu-toggle">‚ò∞</button>
    <nav class="nav-links">
        <a href="{% url 'accounts:my_courses' %}">Kh√≥a h·ªçc c·ªßa t√¥i</a>
        <a href="{% url 'accounts:user_dashboard' %}" {% block nav_dashboard_active %}{% endblock %}>T·∫•t c·∫£ kh√≥a h·ªçc</a>
        <a href="{% url 'accounts:skills' %}">K·ªπ nƒÉng</a>

        <div class="progress-menu">
            <a href="{% url 'accounts:progress_overview' %}" class="progress-label-link">Ti·∫øn ƒë·ªô</a>
        </div>

        <a href="{% url 'accounts:mock_exams_list' %}">Thi th·ª≠</a>
        <a href="{% url 'accounts:scores_page' %}">ƒêi·ªÉm s·ªë</a>
    </nav>
    <div class="profile">
        <img src="{% if user.userprofile.avatar %}{{ user.userprofile.avatar.url }}{% else %}https://i.pravatar.cc/40{% endif %}" alt="avatar" class="avatar">
        <span>{{ request.user.username }}</span>
        <div class="dropdown" id="profileDropdown">
            <a href="{% url 'accounts:profile' %}">H·ªì s∆°</a>
            <a href="{% url 'accounts:logout' %}">ƒêƒÉng xu·∫•t</a>
        </div>
    </div>
</header>

<aside id="sidebar" class="sidebar">
    {% block sidebar %}
    <a href="{% url 'accounts:user_dashboard' %}"></a>
    {% endblock %}
</aside>

<main class="content">
    {% block content %}{% endblock %}
</main>

<script>
// Progress helpers (Gi·ªØ nguy√™n)
function showProgressMenu() {
    const d = document.getElementById('progressDropdown');
    if (d) d.style.display = 'block';
}

function hideProgressMenu() {
    const d = document.getElementById('progressDropdown');
    if (d) d.style.display = 'none';
}

// L·∫•y CSRF token t·ª´ cookies (Gi·ªØ nguy√™n)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% block extra_js %}{% endblock %}

{% if user.is_authenticated %}
<div id="ai-chat-wrapper">
    <button id="ai-chat-toggle">ü§ñ</button>

    <div id="ai-chat-box" class="closed">
        <div id="ai-chat-header">
            Tr·ª£ l√Ω Ng√¥n ng·ªØ AI
            <button id="ai-chat-close" style="background:none; border:none; color:white; font-size: 1.5em; cursor: pointer; float: right;">&times;</button>
        </div>

        <div id="ai-chat-messages">
            <div class="ai-msg bot">
                Ch√†o b·∫°n! T√¥i l√† AI Tutor, s·∫µn s√†ng gi√∫p b·∫°n ph√¢n t√≠ch l·ªói ng·ªØ ph√°p v√† n√¢ng cao t·ª´ v·ª±ng.
                H√£y nh·∫≠p vƒÉn b·∫£n ti·∫øng Anh v√†o √¥ d∆∞·ªõi nh√©!
            </div>
        </div>

        <form id="ai-chat-form">
            <input type="text" id="ai-chat-input" placeholder="H·ªèi t√¥i v·ªÅ ng·ªØ ph√°p, t·ª´ v·ª±ng, b√†i t·∫≠p.">
            <button type="submit" id="ai-chat-send">G·ª≠i</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // C·∫¨P NH·∫¨T ID ELEMENT ƒê·ªÇ KH·ªöP V·ªöI CSS V√Ä LOGIC M·ªöI
        const chatToggle = document.getElementById('ai-chat-toggle');
        const chatBox = document.getElementById('ai-chat-box');
        const chatClose = document.getElementById('ai-chat-close');
        const chatForm = document.getElementById('ai-chat-form');
        const chatInput = document.getElementById('ai-chat-input');
        const chatMessages = document.getElementById('ai-chat-messages');
        const csrftoken = getCookie('csrftoken'); // H√†m getCookie ƒë√£ c√≥ s·∫µn

        // 1. Logic B·∫≠t/T·∫Øt C·ª≠a S·ªï Chat (S·ª≠ d·ª•ng class .closed)
        if (chatToggle && chatBox && chatClose) {
            chatToggle.addEventListener('click', () => {
                // M·ªü chat box b·∫±ng c√°ch x√≥a class 'closed'
                chatBox.classList.remove('closed');
                chatToggle.style.display = 'none';
            });

            chatClose.addEventListener('click', () => {
                // ƒê√≥ng chat box b·∫±ng c√°ch th√™m class 'closed'
                chatBox.classList.add('closed');
                chatToggle.style.display = 'block';
            });
        }

        // 2. X·ª≠ l√Ω G·ª≠i tin nh·∫Øn (S·ª≠ d·ª•ng form submit)
        if (chatForm) {
            const sendMessage = (message) => {
                if (message === "") return;

                // Th√™m tin nh·∫Øn ng∆∞·ªùi d√πng (s·ª≠ d·ª•ng class CSS m·ªõi: .ai-msg.user)
                addMessage(message, 'user');
                chatInput.value = '';

                // Hi·ªÉn th·ªã th√¥ng b√°o ch·ªù
                const loadingMessage = addMessage('ƒêang ph√¢n t√≠ch...', 'bot', true); // S·ª≠ d·ª•ng 'bot' cho tin nh·∫Øn ch·ªù

                // G·ª≠i AJAX request (s·ª≠ d·ª•ng URL ƒë√£ s·ª≠a trong accounts/urls.py)
                fetch('/accounts/ai-analyze/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ 'text': message }) // S·ª≠ d·ª•ng 'text'
                })
                .then(response => {
                    // X√≥a th√¥ng b√°o ch·ªù
                    if (loadingMessage.parentNode) chatMessages.removeChild(loadingMessage);

                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(`L·ªói Server (${response.status}): ${errorData.error || errorData.message || 'Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON.'}`);
                        }).catch(e => {
                            if (response.status === 404) {
                                throw new Error(`L·ªói Server (404): Vui l√≤ng ki·ªÉm tra ƒë·ªãnh tuy·∫øn URL.`);
                            }
                            if (response.status === 503) {
                                throw new Error(`L·ªói Server (503): D·ªãch v·ª• AI kh√¥ng kh·∫£ d·ª•ng (thi·∫øu API Key).`);
                            }
                            throw new Error(`L·ªói k·∫øt n·ªëi m·∫°ng: Vui l√≤ng ki·ªÉm tra console.`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Nh·∫≠n key 'analysis' t·ª´ views.py
                    if (data.analysis) {
                        addMessage(data.analysis, 'bot');
                    } else if (data.error || data.message) {
                        addMessage(`L·ªói t·ª´ server: ${data.error || data.message}`, 'error');
                    }
                })
                .catch(error => {
                    // X·ª≠ l√Ω l·ªói
                    if (loadingMessage.parentNode) {
                         chatMessages.removeChild(loadingMessage);
                    }
                    addMessage(`ƒê√£ x·∫£y ra l·ªói: ${error.message}`, 'error');
                    console.error('AJAX Error:', error);
                });
            };

            // G·∫Øn s·ª± ki·ªán submit cho form
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault(); // NgƒÉn form g·ª≠i ƒëi m·∫∑c ƒë·ªãnh
                const message = chatInput.value.trim();
                sendMessage(message);
            });
        }

        function addMessage(text, sender, isLoading = false) {
            const messageDiv = document.createElement('div');
            // C·∫¨P NH·∫¨T CLASS ELEMENT ƒê·ªÇ KH·ªöP V·ªöI CSS M·ªöI: .ai-msg, .user, .bot, .error
            messageDiv.classList.add('ai-msg', sender);

            if (isLoading) {
                // Th√™m m·ªôt l·ªõp CSS cho ch·∫•m ƒë·ªông n·∫øu c√≥
                messageDiv.innerHTML = `<span class="loading-dots">...</span> ${text}`;
            } else {
                messageDiv.textContent = text;
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }
    });
</script>

{% endif %}
</body>
</html>